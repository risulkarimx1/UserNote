<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UserLog</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: light;
      --background: #f7f3eb;
      --surface: #ffffff;
      --surface-muted: #f1ebe1;
      --surface-strong: #e8dece;
      --text: #1f1b15;
      --text-muted: #6f6658;
      --border: #d9cdb8;
      --border-strong: #c8b89c;
      --accent: #ff7a18;
      --accent-strong: #ff9746;
      --accent-shadow: rgba(255, 122, 24, 0.24);
      --danger: #c34141;
      --radius-lg: 20px;
      --radius-md: 14px;
      --radius-sm: 10px;
      --transition: 0.2s ease;
      --font-mono: 'IBM Plex Mono', 'SFMono-Regular', Menlo, Monaco, Consolas, monospace;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      background: var(--background);
      color: var(--text);
      font-family: var(--font-mono);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    body.modal-open {
      overflow: hidden;
    }

    body.blocking-overlay-active {
      cursor: wait;
    }

    body.blocking-overlay-active .app-shell {
      pointer-events: none;
      user-select: none;
    }

    button {
      font: inherit;
      cursor: pointer;
      border: none;
      background: none;
    }

    .app-shell {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 264px;
      padding: 28px 24px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 24px;
      transition: width 0.3s ease, padding 0.3s ease;
      position: relative;
    }

    .sidebar[data-collapsed="true"] {
      width: 90px;
      padding-inline: 20px;
    }

    .sidebar[data-collapsed="true"] .logo-word,
    .sidebar[data-collapsed="true"] .sidebar-label,
    .sidebar[data-collapsed="true"] .notebook-select-title,
    .sidebar[data-collapsed="true"] .button-label {
      display: none;
    }

    .sidebar[data-collapsed="true"] .toggle-icon {
      transform: rotate(180deg);
    }

    .sidebar-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-actions {
      display: flex;
      width: 100%;
    }

    .sidebar-actions .button {
      width: 100%;
    }

    .logo {
      display: flex;
      align-items: baseline;
      gap: 4px;
      font-weight: 600;
      letter-spacing: 0.04em;
    }

    .logo-dot {
      color: var(--accent);
    }

    .sidebar-toggle {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: border var(--transition), background var(--transition);
    }

    .sidebar-toggle:hover {
      border-color: var(--border-strong);
    }

    .sidebar-label {
      font-size: 13px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .notebook-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
    }

    .notebook-list::-webkit-scrollbar {
      width: 6px;
    }

    .notebook-list::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 999px;
    }

    .notebook-row {
      display: flex;
      width: 100%;
    }

    .notebook-select {
      flex: 1 1 auto;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-radius: var(--radius-md);
      background: var(--surface-muted);
      border: 1px solid transparent;
      color: var(--text);
      text-align: left;
      transition: background var(--transition), border var(--transition), box-shadow var(--transition), transform var(--transition);
    }

    .notebook-select:hover {
      border-color: var(--border-strong);
    }

    .active-notebook {
      background: var(--surface-strong) !important;
      border-color: var(--accent) !important;
      box-shadow: 0 12px 24px rgba(102, 62, 11, 0.12);
    }

    .notebook-select-title {
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .notebook-select-count {
      font-size: 12px;
      color: var(--text-muted);
      margin-left: 12px;
      flex-shrink: 0;
    }
    
    .button-label {
      font-weight: 500;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
    }
    
    .button.full {
      justify-content: space-between;
      padding-left: 20px;
      padding-right: 20px;
    }

    .notebook-skeleton {
      height: 52px;
      border-radius: var(--radius-md);
      background: linear-gradient(90deg, var(--surface-muted) 0%, var(--surface) 50%, var(--surface-muted) 100%);
      background-size: 200% 100%;
      animation: shimmer 1.2s linear infinite;
    }

    @keyframes shimmer {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }

    .main {
      flex: 1;
      display: flex;
      padding: 32px;
      gap: 28px;
    }

    .entries-column {
      width: 320px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .entries-header {
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: stretch;
    }

    .entries-icon-buttons {
      display: inline-flex;
      gap: 0; /* Remove gap since we want them connected */
      justify-content: center;
    }
    
    .entries-icon-buttons .button {
      border-radius: 0;
      border-left-width: 0;
    }
    
    .entries-icon-buttons .button:first-child {
      border-top-left-radius: 999px;
      border-bottom-left-radius: 999px;
      border-left-width: 1px;
    }
    
    .entries-icon-buttons .button:last-child {
      border-top-right-radius: 999px;
      border-bottom-right-radius: 999px;
      border-right-width: 1px;
    }

    .entries-scroll {
      flex: 1;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 0;
      overflow-y: auto;
    }

    .entries-scroll::-webkit-scrollbar {
      width: 6px;
    }

    .entries-scroll::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 999px;
    }

    .entry-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
      border-radius: var(--radius-md);
      border: 1px solid transparent;
      padding: 12px 14px;
      background: var(--surface-muted);
      text-align: left;
      transition: border var(--transition), background var(--transition), box-shadow var(--transition);
    }

    .entry-item:hover {
      border-color: var(--border-strong);
    }

    .entry-item.active {
      border-color: var(--accent);
      background: var(--surface-strong);
      box-shadow: 0 12px 28px rgba(102, 62, 11, 0.14);
    }

    .entry-item-title {
      font-weight: 500;
    }

    .entry-item-meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    .entries-empty {
      border: 1px dashed var(--border);
      border-radius: var(--radius-md);
      padding: 32px 20px;
      text-align: center;
      color: var(--text-muted);
      font-size: 14px;
    }

    .entries-error {
      color: var(--danger);
    }

    .workspace {
      flex: 1;
      position: relative;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 32px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      box-shadow: 0 24px 60px rgba(84, 56, 15, 0.08);
    }

    .workspace-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
    }

    .workspace-title {
      font-size: clamp(24px, 3vw, 36px);
      letter-spacing: -0.02em;
    }

    .workspace-subtitle {
      color: var(--text-muted);
      font-size: 14px;
      max-width: 560px;
    }

    .workspace-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .workspace-form {
      display: flex;
      flex-direction: column;
      gap: 18px;
      flex: 1;
    }

    .field-label {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    .field-input {
      min-height: 220px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: var(--surface-muted);
      padding: 18px 20px;
      font: inherit;
      resize: vertical;
      transition: border var(--transition), box-shadow var(--transition);
    }

    .field-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(255, 122, 24, 0.16);
    }

    .field-input:disabled {
      cursor: not-allowed;
      color: var(--text-muted);
      background: var(--surface);
    }

    .attachments-region {
      display: flex;
      flex-direction: column;
      gap: 14px;
      padding: 18px 20px;
      border-radius: var(--radius-lg);
      border: 1px dashed var(--border);
      background: var(--surface-muted);
    }

    .attachments-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .attachments-title {
      font-weight: 500;
    }

    .attachments-hint {
      font-size: 13px;
      color: var(--text-muted);
    }

    .attachment-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 14px;
    }

    .attachment-card {
      display: flex;
      flex-direction: column;
      gap: 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: var(--surface);
      padding: 12px;
      box-shadow: 0 10px 24px rgba(26, 18, 9, 0.08);
    }

    .attachment-card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      background: var(--surface-muted);
    }

    .attachment-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .attachment-remove {
      border: none;
      background: none;
      color: var(--danger);
      font-size: 12px;
      padding: 0;
      cursor: pointer;
      text-decoration: underline;
    }

    .attachment-placeholder {
      border: 1px dashed var(--border);
      border-radius: var(--radius-md);
      padding: 28px 16px;
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
    }

    .existing-attachments {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .existing-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 14px;
    }

    .existing-card {
      text-decoration: none;
      color: inherit;
      transition: transform var(--transition), box-shadow var(--transition);
    }

    .existing-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 18px 32px rgba(68, 48, 19, 0.12);
    }

    .form-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
      transition: background var(--transition), border var(--transition), box-shadow var(--transition), color var(--transition);
    }

    .button.small {
      padding: 10px 16px;
      font-size: 12px;
    }

    .button.full {
      justify-content: center;
      width: 100%;
    }

    .button.icon {
      width: 44px;
      height: 44px;
      padding: 0;
      border-radius: 50%;
      justify-content: center;
    }

    .button-icon {
      font-size: 18px;
      line-height: 1;
    }

    .button-label {
      display: inline;
    }

    .button.full .button-icon {
      margin-right: 8px;
    }

    .sidebar[data-collapsed="true"] .button.full .button-icon {
      margin-right: 0;
    }

    .sidebar[data-collapsed="true"] .notebook-row {
      justify-content: center;
    }

    .sidebar[data-collapsed="true"] .button[data-initial] {
      width: 48px;
      height: 48px;
      min-width: 48px;
      min-height: 48px;
      max-width: 48px;
      max-height: 48px;
      padding: 0;
      border-radius: 50%;
      justify-content: center;
      font-size: 14px;
      font-weight: 500;
      flex-shrink: 0;
      color: var(--text);
      border: 1px solid var(--border);
      background: var(--surface);
      box-sizing: border-box;
    }

    .sidebar[data-collapsed="true"] .notebook-select-count {
      display: none;
    }

    .button[data-initial]::before {
      content: attr(data-initial);
      display: none;
      font-size: 18px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .sidebar[data-collapsed="true"] .button[data-initial]::before {
      display: block;
      color: var(--text);
    }

    .sidebar[data-collapsed="true"] .button[data-initial]:hover {
      border-color: var(--border-strong);
    }

    .sidebar[data-collapsed="true"] .active-notebook[data-initial] {
      border-color: var(--accent);
      box-shadow: 0 12px 24px rgba(102, 62, 11, 0.12);
    }

    .button.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: #1f1303;
      box-shadow: 0 20px 30px var(--accent-shadow);
    }

    .button.primary:hover:not(:disabled) {
      background: var(--accent-strong);
      border-color: var(--accent-strong);
    }

    .button.secondary {
      background: var(--surface-muted);
      border-color: var(--border);
    }

    .button.secondary:hover:not(:disabled) {
      border-color: var(--border-strong);
      background: var(--surface-strong);
    }

    .button.ghost {
      background: transparent;
    }

    .button.ghost:hover:not(:disabled) {
      border-color: var(--border-strong);
      background: var(--surface-muted);
    }

    .button.danger {
      background: rgba(195, 65, 65, 0.12);
      border-color: rgba(195, 65, 65, 0.4);
      color: var(--danger);
    }

    .delete-notebook {
      align-self: stretch;
      font-weight: 600;
    }

    .button.danger:hover:not(:disabled) {
      background: rgba(195, 65, 65, 0.2);
      border-color: rgba(195, 65, 65, 0.6);
    }

    .button:disabled {
      cursor: not-allowed;
      opacity: 0.6;
      box-shadow: none;
    }

    .status-line {
      min-height: 20px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .status-line.success {
      color: #1f6727;
    }

    .status-line.error {
      color: var(--danger);
    }

    .status-line.loading {
      color: var(--text-muted);
    }

    .generation-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: inherit;
      background: rgba(247, 243, 235, 0.86);
      backdrop-filter: blur(4px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 18px;
      z-index: 10;
      text-align: center;
      padding: 32px;
    }

    .generation-overlay p {
      font-size: 16px;
      color: var(--text);
    }

    .generation-overlay[hidden] {
      display: none !important;
    }

    .modal-root {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      background: rgba(31, 27, 21, 0.36);
      backdrop-filter: blur(6px);
      z-index: 100;
    }

    .modal-root[hidden] {
      display: none !important;
    }

    #loading-overlay .modal-content {
      cursor: wait;
      outline: none;
    }

    .modal-backdrop {
      position: absolute;
      inset: 0;
    }

    .modal-content {
      position: relative;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: 0 40px 80px rgba(31, 21, 8, 0.26);
      padding: 28px;
      width: min(420px, 100%);
      display: flex;
      flex-direction: column;
      gap: 20px;
      animation: modalFade 0.2s ease;
    }

    .modal-title {
      font-size: 20px;
      letter-spacing: -0.01em;
    }

    .modal-text {
      font-size: 14px;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .modal-actions .button {
      min-width: 120px;
    }

    .modal-field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .modal-input {
      width: 100%;
      padding: 12px 14px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--surface-muted);
      font: inherit;
      transition: border var(--transition), box-shadow var(--transition);
    }

    .modal-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(255, 122, 24, 0.2);
    }

    .modal-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .modal-option {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 18px;
      padding: 16px 18px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: var(--surface-muted);
      cursor: pointer;
      transition: border var(--transition), box-shadow var(--transition), background var(--transition);
    }

    .modal-option:hover {
      border-color: var(--accent);
      box-shadow: 0 18px 40px rgba(84, 56, 15, 0.12);
    }

    .modal-option-title {
      font-weight: 500;
    }

    .modal-option-desc {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    @keyframes modalFade {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Animation inspired by ElevenLabs UI equalizer component: https://ui.elevenlabs.io/docs */
    .equalizer {
      display: inline-flex;
      align-items: flex-end;
      gap: 6px;
    }

    .equalizer span {
      width: 10px;
      height: 42px;
      background: linear-gradient(180deg, var(--accent-strong), var(--accent));
      border-radius: 999px;
      animation: equalize 1.2s ease-in-out infinite;
    }

    .equalizer span:nth-child(2) {
      animation-delay: 0.12s;
    }

    .equalizer span:nth-child(3) {
      animation-delay: 0.24s;
    }

    .equalizer span:nth-child(4) {
      animation-delay: 0.36s;
    }

    .equalizer span:nth-child(5) {
      animation-delay: 0.48s;
    }

    @keyframes equalize {
      0%, 100% {
        transform: scaleY(0.4);
      }
      50% {
        transform: scaleY(1);
      }
    }

    @media (max-width: 1200px) {
      .main {
        flex-direction: column;
      }

      .entries-column {
        width: 100%;
        flex-direction: row;
        align-items: flex-start;
      }

      .entries-scroll {
        flex: 1;
        max-height: 320px;
      }
    }

    @media (max-width: 860px) {
      .app-shell {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--border);
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        padding: 20px;
      }

      .sidebar[data-collapsed="true"] {
        width: 100%;
        padding-inline: 20px;
      }

      .notebook-list {
        flex-direction: row;
        overflow-x: auto;
        padding-right: 0;
        max-height: unset;
      }

      .notebook-row {
        min-width: 180px;
      }

      .main {
        padding: 20px;
      }

      .entries-column {
        flex-direction: column;
      }

      .workspace {
        padding: 24px;
      }
    }

    @media (max-width: 640px) {
      .workspace-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .workspace-actions {
        width: 100%;
      }

      .workspace-actions .button {
        flex: 1;
        justify-content: center;
      }

      .form-actions .button {
        flex: 1;
      }

      .entries-icon-buttons {
        width: 100%;
      }

      .entries-icon-buttons .button {
        flex: 1;
        border-radius: 0;
        border-left-width: 0;
      }
      
      .entries-icon-buttons .button:first-child {
        border-top-left-radius: 999px;
        border-bottom-left-radius: 999px;
        border-left-width: 1px;
      }
      
      .entries-icon-buttons .button:last-child {
        border-top-right-radius: 999px;
        border-bottom-right-radius: 999px;
        border-right-width: 1px;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <aside class="sidebar" id="sidebar" data-collapsed="false">
      <div class="sidebar-top">
        <div class="logo">
          <span class="logo-word">UserLog</span>
          <span class="logo-dot">.</span>
        </div>
        <button class="sidebar-toggle" type="button" id="toggle-sidebar" aria-label="Collapse notebook menu">
          <span class="toggle-icon" aria-hidden="true">‹</span>
        </button>
      </div>
      <div class="sidebar-actions">
        <button class="button ghost full" type="button" id="add-notebook" aria-label="Create notebook">
          <span class="button-icon" aria-hidden="true">+</span>
          <span class="button-label">New notebook</span>
        </button>
      </div>
      <div class="sidebar-label">Notebooks</div>
      <nav class="notebook-list" id="notebook-list"></nav>
    </aside>
    <main class="main">
      <section class="entries-column">
        <header class="entries-header">
          <div class="entries-icon-buttons">
            <button class="button primary" type="button" id="new-entry" aria-label="New notebook entry" title="New notebook entry">
              <svg class="button-icon" aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                <path d="M3 7a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7Z"></path>
                <path d="m3 7 9 6 9-6"></path>
              </svg>
              <span class="button-label">New</span>
            </button>
            <button class="button ghost" type="button" id="refresh-logs" aria-label="Refresh notebook" title="Refresh notebook">
              <svg class="button-icon" aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                <path d="M20 11a8.1 8.1 0 0 0-2.32-5.7A7.94 7.94 0 0 0 12 3a7.94 7.94 0 0 0-5.68 2.32A8.1 8.1 0 0 0 3 11h2a6 6 0 0 1 4-5.66A6 6 0 0 1 15.66 7A6 6 0 0 1 17 11"></path>
                <path d="M4 13a8.1 8.1 0 0 0 2.32 5.7A7.94 7.94 0 0 0 12 21a7.94 7.94 0 0 0 5.68-2.32A8.1 8.1 0 0 0 21 13h-2a6 6 0 0 1-4 5.66A6 6 0 0 1 8.34 17A6 6 0 0 1 7 13"></path>
              </svg>
              <span class="button-label">Refresh</span>
            </button>
            <button class="button danger delete-notebook" type="button" id="delete-notebook" aria-label="Delete notebook" title="Delete notebook">
              <svg class="button-icon" aria-hidden="true" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px;">
                <path d="M4 7h16"></path>
                <path d="M10 11v6"></path>
                <path d="M14 11v6"></path>
                <path d="M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2l1-12"></path>
                <path d="M9 7V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v3"></path>
              </svg>
              <span class="button-label">Delete</span>
            </button>
          </div>
        </header>
        <div class="entries-scroll" id="entries-list">
          <div class="entries-empty">Select a notebook to see its history.</div>
        </div>
      </section>
      <section class="workspace" id="workspace">
        <header class="workspace-header">
          <div>
            <h1 class="workspace-title" id="workspace-title">Welcome to UserLog</h1>
            <p class="workspace-subtitle" id="workspace-subtitle">Pick a notebook on the left to start capturing entries.</p>
          </div>
          <div class="workspace-actions">
            <button class="button ghost" type="button" id="export-notebook" disabled>Export</button>
            <button class="button ghost" type="button" id="delete-entry" disabled>Delete entry</button>
          </div>
        </header>
        <form class="workspace-form" id="entry-form" novalidate>
          <label class="field-label" for="entry-text">Entry notes</label>
          <textarea id="entry-text" class="field-input" placeholder="Describe the work, paste raw notes, drop links…" disabled></textarea>
          <div class="attachments-region" id="attachments-region" hidden>
            <div class="attachments-top">
              <span class="attachments-title">Screenshots</span>
              <div class="attachments-actions">
                <input type="file" id="attachment-input" accept="image/*" multiple hidden>
                <button class="button ghost small" type="button" id="open-attachment-picker">Upload images</button>
              </div>
            </div>
            <p class="attachments-hint" id="attachments-hint">Paste screenshots (⌘V / Ctrl+V) or upload files. They will ship with your entry.</p>
            <div class="attachment-grid" id="attachment-list" data-empty="true">
              <div class="attachment-placeholder">No screenshots yet.</div>
            </div>
          </div>
          <div class="existing-attachments" id="existing-attachments" hidden></div>
          <div class="form-actions">
            <button class="button primary" type="button" id="rephrase-entry" disabled>Rephrase</button>
            <button class="button secondary" type="button" id="save-entry" disabled>Save</button>
            <button class="button ghost" type="button" id="discard-entry" disabled>Discard</button>
          </div>
          <p class="status-line" id="entry-status" role="status" aria-live="polite"></p>
        </form>
        <div class="generation-overlay" id="generation-overlay" hidden aria-hidden="true">
          <div class="equalizer" aria-hidden="true">
            <span></span>
            <span></span>
            <span></span>
            <span></span>
            <span></span>
          </div>
          <p>Polishing with Ollama…</p>
        </div>
      </section>
    </main>
  </div>
  <div class="modal-root" id="modal-root" hidden></div>
  <div class="modal-root" id="loading-overlay" hidden aria-hidden="true" role="alertdialog" aria-modal="true" aria-labelledby="loading-overlay-message">
    <div class="modal-content" style="background: var(--surface); text-align: center; padding: 40px;" tabindex="-1">
      <div class="equalizer" aria-hidden="true" style="margin: 0 auto 24px;">
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
      </div>
      <p id="loading-overlay-message" style="font-size: 18px; color: var(--text);" aria-live="assertive">Processing…</p>
    </div>
  </div>
  <script>
    (function() {
      const NOTEBOOK_STORAGE_KEY = 'logbook-fm-current-notebook';
      const state = {
        notebooks: [],
        currentNotebook: window.localStorage.getItem(NOTEBOOK_STORAGE_KEY),
        logs: [],
        mode: 'idle',
        selectedLogId: null,
        attachments: [],
        originalText: '',
        isLoadingNotebooks: false,
        isLoadingLogs: false,
        isSubmitting: false,
        pasteSequence: 1,
        modal: null
      };

      let statusTimeout = null;
      let overlayReturnFocus = null;

      const elements = {
        appShell: document.querySelector('.app-shell'),
        sidebar: document.getElementById('sidebar'),
        toggleSidebar: document.getElementById('toggle-sidebar'),
        notebookList: document.getElementById('notebook-list'),
        addNotebookButton: document.getElementById('add-notebook'),
        newEntryButton: document.getElementById('new-entry'),
        refreshButton: document.getElementById('refresh-logs'),
        deleteNotebookButton: document.getElementById('delete-notebook'),
        entriesList: document.getElementById('entries-list'),
        workspaceTitle: document.getElementById('workspace-title'),
        workspaceSubtitle: document.getElementById('workspace-subtitle'),
        entryTextarea: document.getElementById('entry-text'),
        rephraseButton: document.getElementById('rephrase-entry'),
        saveButton: document.getElementById('save-entry'),
        discardButton: document.getElementById('discard-entry'),
        statusLine: document.getElementById('entry-status'),
        exportButton: document.getElementById('export-notebook'),
        deleteButton: document.getElementById('delete-entry'),
        attachmentsRegion: document.getElementById('attachments-region'),
        attachmentsList: document.getElementById('attachment-list'),
        attachmentsHint: document.getElementById('attachments-hint'),
        attachmentInput: document.getElementById('attachment-input'),
        openAttachmentPicker: document.getElementById('open-attachment-picker'),
        existingAttachments: document.getElementById('existing-attachments'),
        overlay: document.getElementById('generation-overlay'),
        workspaceForm: document.getElementById('entry-form'),
        modalRoot: document.getElementById('modal-root'),
        loadingOverlay: document.getElementById('loading-overlay'),
        loadingOverlayMessage: document.getElementById('loading-overlay-message')
      };

      if (elements.workspaceForm) {
        elements.workspaceForm.addEventListener('submit', (event) => {
          event.preventDefault();
        });
      }

      if (elements.modalRoot) {
        elements.modalRoot.addEventListener('click', (event) => {
          const target = event.target;
          if (!(target instanceof HTMLElement)) return;

          if (target.dataset.modalDismiss !== undefined) {
            closeModal();
            return;
          }

          const action = target.dataset.modalAction;
          if (action) {
            event.preventDefault();
            handleModalAction(action);
          }
        });
      }

      window.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && state.modal) {
          closeModal();
        }
      });

      if (elements.toggleSidebar && elements.sidebar) {
        elements.toggleSidebar.addEventListener('click', () => {
          const isCollapsed = elements.sidebar.getAttribute('data-collapsed') === 'true';
          elements.sidebar.setAttribute('data-collapsed', String(!isCollapsed));
          const icon = elements.toggleSidebar.querySelector('.toggle-icon');
          if (icon) {
            icon.textContent = isCollapsed ? '‹' : '›';
          }
        });
      }

      if (elements.notebookList) {
        elements.notebookList.addEventListener('click', (event) => {
          const selectButton = event.target.closest('[data-notebook-select]');
          if (selectButton) {
            const slug = selectButton.getAttribute('data-notebook-select');
            if (slug) {
              setCurrentNotebook(slug);
            }
          }
        });
      }

      if (elements.addNotebookButton) {
        elements.addNotebookButton.addEventListener('click', () => {
          openModal({ type: 'newNotebook' });
        });
      }

      if (elements.newEntryButton) {
        elements.newEntryButton.addEventListener('click', () => {
          if (!state.currentNotebook) {
            showStatus('Create or select a notebook first.', 'error');
            return;
          }
          setMode('create');
          window.requestAnimationFrame(() => {
            if (elements.entryTextarea) {
              elements.entryTextarea.focus();
            }
          });
        });
      }

      if (elements.refreshButton) {
        elements.refreshButton.addEventListener('click', () => {
          loadLogs();
        });
      }

      if (elements.deleteNotebookButton) {
        elements.deleteNotebookButton.addEventListener('click', () => {
          if (!state.currentNotebook) {
            showStatus('Select a notebook first.', 'error');
            return;
          }
          const notebook = getCurrentNotebook();
          openModal({
            type: 'deleteNotebook',
            slug: state.currentNotebook,
            name: notebook ? notebook.name : ''
          });
        });
      }

      if (elements.entriesList) {
        elements.entriesList.addEventListener('click', (event) => {
          const button = event.target.closest('.entry-item');
          if (!button) return;
          const id = parseInt(button.getAttribute('data-id') || '', 10);
          if (!Number.isFinite(id)) return;
          setMode('edit', id);
        });
      }

      if (elements.entryTextarea) {
        elements.entryTextarea.addEventListener('keydown', (event) => {
          if ((event.metaKey || event.ctrlKey) && event.key === 'Enter') {
            event.preventDefault();
            handleSave({ mode: 'rephrase' });
          }
        });

        elements.entryTextarea.addEventListener('paste', async (event) => {
          if (state.mode !== 'create') {
            return;
          }

          const clipboard = event.clipboardData;
          if (!clipboard) {
            return;
          }

          const images = await extractClipboardImages(clipboard);
          if (images.length === 0) {
            return;
          }

          event.preventDefault();

          let added = 0;
          for (const file of images) {
            const success = await addAttachmentFromFile(file);
            if (success) {
              added += 1;
            }
          }

          if (added > 0) {
            showStatus(added === 1 ? 'Screenshot attached.' : `${added} screenshots attached.`, 'success');
          }
        });

        elements.entryTextarea.addEventListener('input', () => {
          updateControls();
        });
      }

      if (elements.rephraseButton) {
        elements.rephraseButton.addEventListener('click', () => handleSave({ mode: 'rephrase' }));
      }

      if (elements.saveButton) {
        elements.saveButton.addEventListener('click', () => handleSave({ mode: 'save' }));
      }

      if (elements.discardButton) {
        elements.discardButton.addEventListener('click', () => {
          if (state.mode === 'create') {
            elements.entryTextarea.value = '';
            state.attachments = [];
            state.pasteSequence = 1;
            renderPendingAttachments();
            showStatus('Draft cleared.', 'success');
          } else if (state.mode === 'edit' && state.selectedLogId) {
            const log = state.logs.find((entry) => entry.id === state.selectedLogId);
            if (log) {
              elements.entryTextarea.value = log.text;
              state.originalText = log.text;
              showStatus('Changes discarded.', 'success');
            }
          }
          updateControls();
        });
      }

      if (elements.deleteButton) {
        elements.deleteButton.addEventListener('click', () => {
          if (state.mode !== 'edit' || !state.selectedLogId || !state.currentNotebook) {
            return;
          }

          const log = state.logs.find((entry) => entry.id === state.selectedLogId) || null;
          openModal({
            type: 'deleteEntry',
            logId: state.selectedLogId,
            title: log ? getLogTitle(log) : `Entry ${state.selectedLogId}`
          });
        });
      }

      if (elements.exportButton) {
        elements.exportButton.addEventListener('click', () => {
          if (!state.currentNotebook) {
            showStatus('Select a notebook to export.', 'error');
            return;
          }
          openModal({ type: 'export' });
        });
      }

      if (elements.openAttachmentPicker && elements.attachmentInput) {
        elements.openAttachmentPicker.addEventListener('click', () => {
          if (state.mode !== 'create') return;
          elements.attachmentInput.click();
        });

        elements.attachmentInput.addEventListener('change', async (event) => {
          const input = event.target;
          if (!input.files || input.files.length === 0) return;
          await handleFiles(input.files);
          input.value = '';
        });
      }

      if (elements.attachmentsList) {
        elements.attachmentsList.addEventListener('click', (event) => {
          const button = event.target.closest('[data-remove-attachment]');
          if (!button) return;
          const id = button.getAttribute('data-remove-attachment');
          if (!id) return;
          state.attachments = state.attachments.filter((item) => item.id !== id);
          renderPendingAttachments();
          updateControls();
        });
      }

      loadNotebooks();
      renderNotebooks();
      renderEntries();
      renderWorkspace();
      updateControls();

      async function loadNotebooks() {
        state.isLoadingNotebooks = true;
        renderNotebooks();

        try {
          const response = await fetch('/api/notebooks');
          const list = await response.json();
          state.isLoadingNotebooks = false;

          if (!Array.isArray(list)) {
            throw new Error('Unexpected response');
          }

          state.notebooks = list.sort((a, b) => a.name.localeCompare(b.name));

          if (state.notebooks.length === 0) {
            state.currentNotebook = null;
            state.logs = [];
            clearStoredNotebook();
            renderNotebooks();
            renderEntries();
            setMode('idle');
            return;
          }

          if (!state.currentNotebook || !state.notebooks.some((notebook) => notebook.slug === state.currentNotebook)) {
            state.currentNotebook = state.notebooks[0].slug;
            storeNotebook(state.currentNotebook);
          }

          renderNotebooks();
          setMode(state.currentNotebook ? 'create' : 'idle');
          await loadLogs();
        } catch (error) {
          state.isLoadingNotebooks = false;
          renderNotebooks(true);
          setMode('idle');
          showStatus('Could not load notebooks.', 'error');
        }
      }

      async function loadLogs(options = {}) {
        if (!state.currentNotebook) {
          state.logs = [];
          renderEntries();
          renderWorkspace();
          return;
        }

        state.isLoadingLogs = true;
        renderEntries();

        try {
          const response = await fetch(`/api/notebooks/${encodeURIComponent(state.currentNotebook)}/logs`);
          const logs = await response.json();
          state.isLoadingLogs = false;

          if (!Array.isArray(logs)) {
            throw new Error('Unexpected response');
          }

          state.logs = logs.sort((a, b) => a.id - b.id);
          const notebook = getCurrentNotebook();
          if (notebook) {
            notebook.logCount = state.logs.length;
          }

          renderNotebooks();
          renderEntries();

          const targetId = options.selectId
            ? Number(options.selectId)
            : (state.mode === 'edit' ? state.selectedLogId : null);

          if (targetId && state.logs.some((log) => log.id === targetId)) {
            setMode('edit', targetId);
          } else if (state.mode === 'edit' && state.selectedLogId && !state.logs.some((log) => log.id === state.selectedLogId)) {
            setMode('create');
          } else {
            renderWorkspace();
            renderExistingAttachments();
          }
        } catch (error) {
          state.isLoadingLogs = false;
          renderEntries(true);
          showStatus('Failed to load entries.', 'error');
        }
      }

      async function handleSave(options = {}) {
        if (state.mode === 'idle' || !state.currentNotebook) {
          showStatus('Select a notebook first.', 'error');
          return;
        }

        const mode = typeof options.mode === 'string' && options.mode === 'save' ? 'save' : 'rephrase';
        const shouldRephrase = mode === 'rephrase';

        // If rephrasing, check Ollama availability first
        if (shouldRephrase) {
          try {
            const response = await fetch('/api/ollama/health');
            const health = await response.json();
            
            if (!health.available) {
              // Show informative popup about Ollama installation
              openOllamaNotAvailableModal();
              return;
            }
          } catch (error) {
            console.error('Failed to check Ollama status:', error);
            openOllamaNotAvailableModal();
            return;
          }
        }

        const text = elements.entryTextarea.value.trim();
        if (!text) {
          showStatus('Add some details before saving.', 'error');
          elements.entryTextarea.focus();
          return;
        }

        let showedLoadingStatus = false;

        try {
          state.isSubmitting = true;
          updateControls();

          if (shouldRephrase) {
            toggleOverlay(true, 'Polishing with Ollama…');
          } else {
            showStatus('Saving entry…', 'loading');
            showedLoadingStatus = true;
          }

          if (state.mode === 'create') {
            const payload = {
              text,
              mode,
              attachments: state.attachments.map((attachment) => ({
                type: 'image',
                dataUrl: attachment.dataUrl,
                name: attachment.name
              }))
            };

            const response = await fetch(`/api/notebooks/${encodeURIComponent(state.currentNotebook)}/logs`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            const result = await readJson(response);
            if (!response.ok) {
              showStatus(result?.error || 'Failed to create entry.', 'error');
              return;
            }

            showStatus(`${shouldRephrase ? 'Rephrased' : 'Saved'}: ${getLogTitle(result)}`, 'success');
            await loadLogs({ selectId: result.id });
            state.attachments = [];
            state.pasteSequence = 1;
          } else if (state.mode === 'edit' && state.selectedLogId) {
            const response = await fetch(
              `/api/notebooks/${encodeURIComponent(state.currentNotebook)}/logs/${state.selectedLogId}`,
              {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text, mode })
              }
            );

            const result = await readJson(response);
            if (!response.ok) {
              showStatus(result?.error || 'Failed to update entry.', 'error');
              return;
            }

            state.originalText = result.text;
            showStatus(`${shouldRephrase ? 'Rephrased' : 'Saved'}: ${getLogTitle(result)}`, 'success');
            await loadLogs({ selectId: result.id });
          }
        } catch (error) {
          console.error('Save entry failed', error);
          showStatus('Network error while saving entry.', 'error');
        } finally {
          state.isSubmitting = false;
          if (shouldRephrase) {
            toggleOverlay(false);
          } else if (showedLoadingStatus) {
            // ensure loading indicator clears if we exit early without success message
            // Successful or error calls already replaced the status message.
          }
          updateControls();
        }
      }

      function openModal(config) {
        state.modal = config;
        renderModal();
      }

      function closeModal() {
        state.modal = null;
        renderModal();
      }

      function openOllamaNotAvailableModal() {
        openModal({ type: 'ollamaNotAvailable' });
      }

      function renderModal() {
        if (!elements.modalRoot) return;

        const modal = state.modal;
        if (!modal) {
          elements.modalRoot.innerHTML = '';
          elements.modalRoot.hidden = true;
          document.body.classList.remove('modal-open');
          return;
        }

        document.body.classList.add('modal-open');

        let panel = '';
        if (modal.type === 'newNotebook') {
          panel = `
            <h2 class="modal-title">Create notebook</h2>
            <p class="modal-text">Group related logs together to keep your notes organised.</p>
            <div class="modal-field">
              <label class="field-label" for="modal-notebook-name">Notebook name</label>
              <input class="modal-input" id="modal-notebook-name" type="text" placeholder="e.g. Release 1.2" data-modal-autofocus>
            </div>
            <div class="modal-actions">
              <button class="button ghost" type="button" data-modal-action="cancel-modal">Cancel</button>
              <button class="button primary" type="button" data-modal-action="submit-new-notebook">Create notebook</button>
            </div>
          `;
        } else if (modal.type === 'deleteNotebook') {
          const name = modal.name ? escapeHtml(modal.name) : 'this notebook';
          panel = `
            <h2 class="modal-title">Delete notebook</h2>
            <p class="modal-text">Deleting <strong>${name}</strong> removes all entries and attachments. This action cannot be undone.</p>
            <div class="modal-actions">
              <button class="button ghost" type="button" data-modal-action="cancel-modal">Keep notebook</button>
              <button class="button danger" type="button" data-modal-action="confirm-delete-notebook">Delete notebook</button>
            </div>
          `;
        } else if (modal.type === 'export') {
          const notebook = getCurrentNotebook();
          const name = notebook ? escapeHtml(notebook.name) : 'notebook';
          panel = `
            <h2 class="modal-title">Export ${name}</h2>
            <p class="modal-text">Choose a format to save or share this logbook.</p>
            <div class="modal-options">
              <button class="modal-option" type="button" data-modal-action="export-markdown">
                <div>
                  <div class="modal-option-title">Markdown (.md)</div>
                  <div class="modal-option-desc">Perfect for docs, repos, or note apps.</div>
                </div>
                <span class="button-icon" aria-hidden="true">↧</span>
              </button>
              <button class="modal-option" type="button" data-modal-action="export-pdf">
                <div>
                  <div class="modal-option-title">PDF (print ready)</div>
                  <div class="modal-option-desc">Generate a printable summary via your browser.</div>
                </div>
                <span class="button-icon" aria-hidden="true">🖨</span>
              </button>
            </div>
            <div class="modal-actions">
              <button class="button ghost" type="button" data-modal-action="cancel-modal">Close</button>
            </div>
          `;
        } else if (modal.type === 'deleteEntry') {
          const title = modal.title ? escapeHtml(modal.title) : 'this entry';
          panel = `
            <h2 class="modal-title">Delete entry</h2>
            <p class="modal-text">Remove <strong>${title}</strong>? This cannot be undone.</p>
            <div class="modal-actions">
              <button class="button ghost" type="button" data-modal-action="cancel-modal">Cancel</button>
              <button class="button danger" type="button" data-modal-action="confirm-delete-entry">Delete entry</button>
            </div>
          `;
        } else if (modal.type === 'ollamaNotAvailable') {
          panel = `
            <h2 class="modal-title">Ollama Not Available</h2>
            <p class="modal-text">The rephrase feature requires Ollama to be installed and running on your system.</p>
            <div class="modal-field">
              <h3 class="field-label">Installation Steps (if not installed):</h3>
              <ol style="padding-left: 20px; margin: 12px 0; text-align: left;">
                <li style="margin-bottom: 8px;">Install Ollama from <a href="https://ollama.ai" target="_blank" style="color: var(--accent);">https://ollama.ai</a></li>
                <li style="margin-bottom: 8px;">Start the Ollama service (usually runs on system startup)</li>
                <li>Run: <code style="background: var(--surface-muted); padding: 4px 8px; border-radius: 4px; font-family: var(--font-mono);">ollama pull llama3.2</code> in terminal</li>
              </ol>
              <h3 class="field-label" style="margin-top: 16px;">Service Startup (if already installed):</h3>
              <div style="margin: 12px 0; text-align: left;">
                <p><strong>macOS:</strong></p>
                <ul style="padding-left: 20px;">
                  <li>Check if running: <code style="background: var(--surface-muted); padding: 2px 6px; border-radius: 4px; font-family: var(--font-mono);">brew services list | grep ollama</code></li>
                  <li>Start service: <code style="background: var(--surface-muted); padding: 2px 6px; border-radius: 4px; font-family: var(--font-mono);">brew services start ollama</code></li>
                </ul>
                <p><strong>Linux:</strong></p>
                <ul style="padding-left: 20px;">
                  <li>Check if running: <code style="background: var(--surface-muted); padding: 2px 6px; border-radius: 4px; font-family: var(--font-mono);">systemctl --user status ollama</code></li>
                  <li>Start service: <code style="background: var(--surface-muted); padding: 2px 6px; border-radius: 4px; font-family: var(--font-mono);">systemctl --user start ollama</code></li>
                </ul>
              </div>
              <p style="margin-top: 12px;">Once Ollama is running, the rephrase feature will work automatically.</p>
            </div>
            <div class="modal-actions">
              <button class="button ghost" type="button" data-modal-action="cancel-modal">Close</button>
            </div>
          `;
        }

        if (!panel) {
          state.modal = null;
          renderModal();
          return;
        }

        elements.modalRoot.innerHTML = `
          <div class="modal-backdrop" data-modal-dismiss="true"></div>
          <div class="modal-content">${panel}</div>
        `;
        elements.modalRoot.hidden = false;

        window.requestAnimationFrame(() => {
          if (!elements.modalRoot) return;
          const focusTarget = elements.modalRoot.querySelector('[data-modal-autofocus]');
          if (focusTarget instanceof HTMLElement) {
            focusTarget.focus();
            if ('select' in focusTarget) {
              try {
                focusTarget.select();
              } catch (error) {
                // ignore
              }
            }
          }

          const nameInput = elements.modalRoot.querySelector('#modal-notebook-name');
          if (nameInput instanceof HTMLInputElement) {
            nameInput.addEventListener('keydown', (event) => {
              if (event.key === 'Enter') {
                event.preventDefault();
                handleModalAction('submit-new-notebook');
              }
            });
          }
        });
      }

      async function handleModalAction(action) {
        const modal = state.modal;
        if (!modal) {
          return;
        }

        if (action === 'cancel-modal') {
          closeModal();
          return;
        }

        if (action === 'submit-new-notebook') {
          const input = elements.modalRoot?.querySelector('#modal-notebook-name');
          if (!(input instanceof HTMLInputElement)) {
            return;
          }

          const name = input.value.trim();
          if (!name) {
            input.focus();
            showStatus('Notebook name is required.', 'error');
            return;
          }

          const buttons = elements.modalRoot?.querySelectorAll('button');
          buttons?.forEach((btn) => {
            if (btn instanceof HTMLButtonElement) {
              btn.disabled = true;
            }
          });
          input.disabled = true;

          try {
            const response = await fetch('/api/notebooks', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name })
            });

            const result = await response.json();
            if (!response.ok) {
              showStatus(result.error || 'Unable to create notebook.', 'error');
              input.disabled = false;
              buttons?.forEach((btn) => {
                if (btn instanceof HTMLButtonElement) {
                  btn.disabled = false;
                }
              });
              return;
            }

            state.notebooks.push(result);
            state.notebooks.sort((a, b) => a.name.localeCompare(b.name));
            closeModal();
            renderNotebooks();
            setCurrentNotebook(result.slug);
            showStatus(`Notebook ${result.name} added.`, 'success');
          } catch (error) {
            showStatus('Network error while creating notebook.', 'error');
            input.disabled = false;
            buttons?.forEach((btn) => {
              if (btn instanceof HTMLButtonElement) {
                btn.disabled = false;
              }
            });
          }
          return;
        }

        if (action === 'confirm-delete-notebook') {
          if (!modal.slug) {
            closeModal();
            return;
          }

          const deleteButton = elements.modalRoot?.querySelector('[data-modal-action="confirm-delete-notebook"]');
          if (deleteButton instanceof HTMLButtonElement) {
            deleteButton.disabled = true;
            deleteButton.textContent = 'Deleting…';
          }

          try {
            const response = await fetch(`/api/notebooks/${encodeURIComponent(modal.slug)}`, {
              method: 'DELETE'
            });

            if (!response.ok) {
              const result = await response.json().catch(() => ({}));
              showStatus(result.error || 'Failed to delete notebook.', 'error');
              if (deleteButton instanceof HTMLButtonElement) {
                deleteButton.disabled = false;
                deleteButton.textContent = 'Delete notebook';
              }
              return;
            }

            closeModal();
            const notebookLabel = modal.name || modal.slug || 'notebook';
            if (state.currentNotebook === modal.slug) {
              state.currentNotebook = null;
            }
            showStatus(`Notebook ${notebookLabel} deleted.`, 'success');
            await loadNotebooks();
          } catch (error) {
            showStatus('Network error while deleting notebook.', 'error');
            if (deleteButton instanceof HTMLButtonElement) {
              deleteButton.disabled = false;
              deleteButton.textContent = 'Delete notebook';
            }
          }
          return;
        }

        if (action === 'confirm-delete-entry') {
          if (modal.logId) {
            closeModal();
            await deleteLogById(modal.logId);
          }
          return;
        }

        if (action === 'export-markdown') {
          closeModal();
          await exportNotebook('markdown');
          return;
        }

        if (action === 'export-pdf') {
          closeModal();
          await exportNotebook('pdf');
        }
      }

      async function deleteLogById(id) {
        if (!state.currentNotebook) {
          return;
        }

        try {
          const response = await fetch(`/api/notebooks/${encodeURIComponent(state.currentNotebook)}/logs/${id}`, {
            method: 'DELETE'
          });

          if (!response.ok) {
            showStatus('Failed to delete entry.', 'error');
            return;
          }

          showStatus('Entry deleted.', 'success');
          state.selectedLogId = null;
          state.originalText = '';
          await loadLogs();
          setMode('create');
        } catch (error) {
          showStatus('Network error while deleting entry.', 'error');
        }
      }

      async function exportNotebook(format) {
        if (!state.currentNotebook) {
          showStatus('Select a notebook to export.', 'error');
          return;
        }

        let exportCompleted = false;
        let minimumDisplayTime = null;
        
        try {
          // Show full-screen loading overlay with appropriate message
          const loadingMessage = format === 'markdown' ? 'Generating Markdown file…' : 'Generating PDF…';
          console.log('Showing loading overlay:', loadingMessage); // Debug log
          showFullScreenLoading(loadingMessage);

          // Set minimum display time to ensure the overlay is visible to users
          minimumDisplayTime = new Promise(resolve => setTimeout(resolve, 500)); // 500ms minimum

          const response = await fetch(`/api/notebooks/${encodeURIComponent(state.currentNotebook)}/export`);
          if (!response.ok) {
            const result = await response.json().catch(() => ({}));
            hideFullScreenLoading();
            await minimumDisplayTime; // Ensure minimum time has passed
            showStatus(result.error || 'Failed to export notebook.', 'error');
            return;
          }

          const markdown = await response.text();
          const notebook = getCurrentNotebook();
          const filenameBase = notebook ? notebook.slug : state.currentNotebook;

          if (format === 'markdown') {
            // Create a temporary link to trigger the download dialog
            const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8' });
            const url = window.URL.createObjectURL(blob);
            
            // Create a temporary link and trigger the download manually
            const link = document.createElement('a');
            link.href = url;
            link.download = `${filenameBase}.md`;
            document.body.appendChild(link); // Add to DOM before clicking
            
            // This will trigger the browser's save dialog
            link.click();
            
            // Clean up
            document.body.removeChild(link); // Remove from DOM after clicking
            window.URL.revokeObjectURL(url);
            
            exportCompleted = true;
            hideFullScreenLoading();
            await minimumDisplayTime; // Ensure minimum time has passed
            showStatus('Export ready. Check your downloads.', 'success');
          } else {
            exportCompleted = true;
            hideFullScreenLoading();
            await minimumDisplayTime; // Ensure minimum time has passed
            exportMarkdownAsPdf(markdown, filenameBase);
          }
        } catch (error) {
          console.error('Export error:', error); // Debug log
          hideFullScreenLoading();
          if (minimumDisplayTime) {
            await minimumDisplayTime; // Ensure minimum time has passed
          }
          showStatus('Network error while exporting.', 'error');
        }
      }

      function exportMarkdownAsPdf(markdown, filenameBase) {
        const printWindow = window.open('', '_blank');
        if (!printWindow) {
          showStatus('Popup blocked. Allow popups to export PDF.', 'error');
          return;
        }

        const escaped = escapeHtml(markdown);
        const safeTitle = escapeHtml(filenameBase);
        printWindow.document.write(`
          <html>
            <head>
              <title>${safeTitle} export</title>
              <style>
                body {
                  font-family: 'IBM Plex Mono', 'SFMono-Regular', Menlo, Monaco, Consolas, monospace;
                  background: #ffffff;
                  color: #1f1b15;
                  line-height: 1.6;
                  white-space: pre-wrap;
                  padding: 48px;
                }
                h1, h2, h3 {
                  font-weight: 600;
                  margin-top: 32px;
                }
                pre {
                  white-space: pre-wrap;
                }
              </style>
            </head>
            <body>
              <pre>${escaped}</pre>
            </body>
          </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        showStatus('Print dialog opened for PDF export.', 'success');
      }

      async function handleFiles(fileList) {
        if (state.mode !== 'create') return;

        const files = Array.from(fileList).filter((file) => file.type && file.type.startsWith('image/'));
        if (files.length === 0) {
          showStatus('Only image files can be attached.', 'error');
          return;
        }

        let added = 0;
        for (const file of files) {
          const success = await addAttachmentFromFile(file);
          if (success) {
            added += 1;
          }
        }

        if (added > 0) {
          showStatus(added === 1 ? 'Screenshot attached.' : `${added} screenshots attached.`, 'success');
        }
      }

      function pushAttachment(attachment) {
        state.attachments.push({
          id: `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
          dataUrl: attachment.dataUrl,
          name: attachment.name || `Screenshot ${state.pasteSequence}`,
          mimeType: attachment.mimeType
        });
        state.pasteSequence += 1;
        renderPendingAttachments();
        updateControls();
      }

      function setCurrentNotebook(slug) {
        if (!slug || !state.notebooks.some((notebook) => notebook.slug === slug)) {
          state.currentNotebook = null;
          clearStoredNotebook();
          setMode('idle');
          renderNotebooks();
          renderEntries();
          return;
        }

        state.currentNotebook = slug;
        storeNotebook(slug);
        setMode('create');
        renderNotebooks();
        loadLogs();
      }

      function setMode(nextMode, logId) {
        state.mode = nextMode;

        if (nextMode === 'create') {
          state.selectedLogId = null;
          state.originalText = '';
          state.attachments = [];
          state.pasteSequence = 1;
          if (elements.entryTextarea) {
            elements.entryTextarea.value = '';
          }
        } else if (nextMode === 'edit') {
          const log = state.logs.find((entry) => entry.id === logId);
          if (log) {
            state.selectedLogId = log.id;
            state.originalText = log.text;
            if (elements.entryTextarea) {
              elements.entryTextarea.value = log.text;
            }
          } else {
            state.selectedLogId = null;
            state.mode = 'create';
          }
          state.attachments = [];
        } else {
          state.selectedLogId = null;
          state.originalText = '';
          state.attachments = [];
          state.pasteSequence = 1;
          if (elements.entryTextarea) {
            elements.entryTextarea.value = '';
          }
        }

        renderWorkspace();
        renderPendingAttachments();
        renderExistingAttachments();
        updateControls();
      }

      const notebookColors = [
        '#e8b5ce', // soft pink
        '#b5d4e8', // soft blue
        '#d4e8b5', // soft green
        '#e8d4b5', // soft peach
        '#d4b5e8', // soft purple
        '#e8c5b5', // soft coral
        '#b5e8d4', // soft mint
        '#e8b5b5', // soft rose
        '#b5c5e8', // soft lavender
        '#d4e8c5'  // soft sage
      ];

      function getNotebookColor(index) {
        return notebookColors[index % notebookColors.length];
      }

      function renderNotebooks(error = false) {
        if (!elements.notebookList) return;

        if (error) {
          elements.notebookList.innerHTML = '<div class="entries-empty">Failed to load notebooks.</div>';
          return;
        }

        if (state.isLoadingNotebooks) {
          elements.notebookList.innerHTML = `
            <div class="notebook-skeleton"></div>
            <div class="notebook-skeleton"></div>
            <div class="notebook-skeleton"></div>
          `;
          return;
        }

        if (!state.notebooks.length) {
          elements.notebookList.innerHTML = '<div class="entries-empty">No notebooks yet. Create one to begin.</div>';
          return;
        }

        elements.notebookList.innerHTML = state.notebooks
          .map((notebook, index) => {
            const isActive = notebook.slug === state.currentNotebook;
            const initial = notebook.name.charAt(0).toUpperCase();
            const color = getNotebookColor(index);
            return `
              <button class="button ghost full sidebar-actions ${isActive ? 'active-notebook' : ''}" type="button" data-notebook-select="${escapeAttribute(notebook.slug)}" data-initial="${escapeAttribute(initial)}">
                <span class="button-label">${escapeHtml(notebook.name)}</span>
                <span class="notebook-select-count">${notebook.logCount ?? 0}</span>
              </button>
            `;
          })
          .join('');
      }

      function renderEntries(error = false) {
        if (!elements.entriesList) return;

        if (!state.currentNotebook) {
          elements.entriesList.innerHTML = '<div class="entries-empty">Select a notebook to see its history.</div>';
          return;
        }

        if (error) {
          elements.entriesList.innerHTML = '<div class="entries-empty entries-error">Failed to load entries. Try refreshing.</div>';
          return;
        }

        if (state.isLoadingLogs) {
          elements.entriesList.innerHTML = `
            <div class="notebook-skeleton"></div>
            <div class="notebook-skeleton"></div>
            <div class="notebook-skeleton"></div>
          `;
          return;
        }

        if (!state.logs.length) {
          elements.entriesList.innerHTML = '<div class="entries-empty">No entries yet. Create one to document your work.</div>';
          return;
        }

        const sorted = [...state.logs].sort((a, b) => b.id - a.id);
        const markup = sorted
          .map((log) => {
            const isActive = state.mode === 'edit' && state.selectedLogId === log.id;
            const title = escapeHtml(getLogTitle(log));
            const summary = getLogSummary(log);
            const meta = summary ? `${escapeHtml(log.date)} · ${escapeHtml(summary)}` : escapeHtml(log.date);

            return `
              <button class="entry-item ${isActive ? 'active' : ''}" type="button" data-id="${log.id}">
                <span class="entry-item-title">${title}</span>
                <span class="entry-item-meta">${meta}</span>
              </button>
            `;
          })
          .join('');

        elements.entriesList.innerHTML = markup;
      }

      function renderWorkspace() {
        const notebook = getCurrentNotebook();
        const hasNotebook = Boolean(notebook);

        if (!hasNotebook) {
          if (elements.workspaceTitle) {
            elements.workspaceTitle.textContent = 'Welcome to UserLog';
          }
          if (elements.workspaceSubtitle) {
            elements.workspaceSubtitle.textContent = 'Pick a notebook on the left to start capturing entries.';
          }
          if (elements.entryTextarea) {
            elements.entryTextarea.disabled = true;
          }
          if (elements.attachmentsRegion) {
            elements.attachmentsRegion.hidden = true;
          }
          if (elements.existingAttachments) {
            elements.existingAttachments.hidden = true;
            elements.existingAttachments.innerHTML = '';
          }
          return;
        }

        if (elements.entryTextarea) {
          elements.entryTextarea.disabled = false;
        }

        if (state.mode === 'create') {
          if (elements.workspaceTitle) {
            elements.workspaceTitle.textContent = 'Add new entry';
          }
          if (elements.workspaceSubtitle) {
            elements.workspaceSubtitle.textContent = `${notebook.name} — ${notebook.logCount ?? 0} saved entries`;
          }
          if (elements.attachmentsRegion) {
            elements.attachmentsRegion.hidden = false;
          }
          if (elements.existingAttachments) {
            elements.existingAttachments.hidden = true;
            elements.existingAttachments.innerHTML = '';
          }
        } else if (state.mode === 'edit') {
          const log = state.logs.find((entry) => entry.id === state.selectedLogId);
          if (log) {
            if (elements.workspaceTitle) {
              elements.workspaceTitle.textContent = getLogTitle(log);
            }
            if (elements.workspaceSubtitle) {
              elements.workspaceSubtitle.textContent = `Editing • ${notebook.name} • ${log.date}`;
            }
            if (elements.attachmentsRegion) {
              elements.attachmentsRegion.hidden = true;
            }
            renderExistingAttachments(log);
          }
        } else {
          if (elements.workspaceTitle) {
            elements.workspaceTitle.textContent = 'Select an entry';
          }
          if (elements.workspaceSubtitle) {
            elements.workspaceSubtitle.textContent = `${notebook.name} — choose an entry or create a new one.`;
          }
        }
      }

      function renderPendingAttachments() {
        if (!elements.attachmentsList) return;

        if (state.mode !== 'create') {
          elements.attachmentsList.innerHTML = '';
          elements.attachmentsList.dataset.empty = 'true';
          return;
        }

        if (state.attachments.length === 0) {
          elements.attachmentsList.innerHTML = '<div class="attachment-placeholder">No screenshots yet.</div>';
          elements.attachmentsList.dataset.empty = 'true';
          return;
        }

        elements.attachmentsList.dataset.empty = 'false';
        elements.attachmentsList.innerHTML = state.attachments
          .map((attachment) => `
            <div class="attachment-card" data-id="${attachment.id}">
              <img src="${attachment.dataUrl}" alt="${escapeAttribute(attachment.name)}">
              <div class="attachment-meta">
                <span class="attachment-name">${escapeHtml(attachment.name)}</span>
                <button class="attachment-remove" type="button" data-remove-attachment="${attachment.id}">Remove</button>
              </div>
            </div>
          `)
          .join('');
      }

      function renderExistingAttachments(log) {
        if (!elements.existingAttachments) return;

        const currentLog = log || state.logs.find((entry) => entry.id === state.selectedLogId);

        if (
          state.mode !== 'edit' ||
          !currentLog ||
          !Array.isArray(currentLog.attachments) ||
          currentLog.attachments.length === 0
        ) {
          elements.existingAttachments.hidden = true;
          elements.existingAttachments.innerHTML = '';
          return;
        }

        const cards = currentLog.attachments
          .filter((attachment) => attachment.type === 'image' && attachment.url)
          .map((attachment) => `
            <a class="attachment-card existing-card" href="${escapeAttribute(attachment.url)}" target="_blank" rel="noopener">
              <img src="${escapeAttribute(attachment.url)}" alt="${escapeAttribute(attachment.name || 'Attachment image')}">
              <span class="attachment-name">${escapeHtml(attachment.name || 'Attachment image')}</span>
            </a>
          `)
          .join('');

        if (!cards) {
          elements.existingAttachments.hidden = true;
          elements.existingAttachments.innerHTML = '';
          return;
        }

        elements.existingAttachments.hidden = false;
        elements.existingAttachments.innerHTML = `
          <span class="attachments-title existing-title">Attached screenshots</span>
          <div class="attachment-grid existing-grid">${cards}</div>
        `;
      }

      function updateControls() {
        const hasNotebook = Boolean(state.currentNotebook);
        const canEdit = state.mode !== 'idle' && hasNotebook;

        if (elements.newEntryButton) {
          elements.newEntryButton.disabled = !hasNotebook || state.isSubmitting;
        }

        if (elements.refreshButton) {
          elements.refreshButton.disabled = !hasNotebook;
        }

        if (elements.deleteNotebookButton) {
          elements.deleteNotebookButton.disabled = !hasNotebook || state.isSubmitting;
        }

        if (elements.exportButton) {
          elements.exportButton.disabled = !hasNotebook;
        }

        if (elements.deleteButton) {
          elements.deleteButton.disabled = !(state.mode === 'edit' && state.selectedLogId && hasNotebook) || state.isSubmitting;
        }

        const trimmedText = elements.entryTextarea.value.trim();
        const hasText = trimmedText.length > 0;
        const isEditedTextDifferent =
          state.mode === 'edit' && trimmedText !== state.originalText.trim();
        const actionReady = state.mode === 'create' ? hasText : isEditedTextDifferent;
        const discardReady =
          state.mode === 'create' ? hasText || state.attachments.length > 0 : isEditedTextDifferent;

        if (elements.rephraseButton) {
          elements.rephraseButton.disabled = !canEdit || state.isSubmitting || !actionReady;
        }

        if (elements.saveButton) {
          elements.saveButton.disabled = !canEdit || state.isSubmitting || !actionReady;
        }

        if (elements.discardButton) {
          elements.discardButton.disabled = !canEdit || !discardReady || state.isSubmitting;
        }

        if (elements.openAttachmentPicker) {
          elements.openAttachmentPicker.disabled = state.mode !== 'create' || state.isSubmitting;
        }
      }

      function toggleOverlay(show, message = 'Processing…') {
        if (!elements.overlay) return;

        // Update the message if showing the overlay
        if (show) {
          const messageElement = elements.overlay.querySelector('p');
          if (messageElement) {
            messageElement.textContent = message;
          }
        }

        elements.overlay.hidden = !show;
        elements.overlay.setAttribute('aria-hidden', String(!show));
      }

      function showFullScreenLoading(message = 'Processing…') {
        if (!elements.loadingOverlay || !elements.loadingOverlayMessage) return;

        if (document.activeElement instanceof HTMLElement) {
          overlayReturnFocus = document.activeElement;
        } else {
          overlayReturnFocus = null;
        }

        elements.loadingOverlayMessage.textContent = message;
        elements.loadingOverlay.hidden = false;
        elements.loadingOverlay.setAttribute('aria-hidden', 'false');
        document.body.classList.add('modal-open', 'blocking-overlay-active');
        if (elements.appShell instanceof HTMLElement) {
          elements.appShell.setAttribute('inert', '');
          elements.appShell.setAttribute('aria-hidden', 'true');
        }

        window.requestAnimationFrame(() => {
          if (!elements.loadingOverlay) return;
          const focusTarget = elements.loadingOverlay.querySelector('.modal-content');
          if (focusTarget instanceof HTMLElement) {
            focusTarget.focus();
          }
        });
      }

      function hideFullScreenLoading() {
        if (!elements.loadingOverlay) return;

        elements.loadingOverlay.hidden = true;
        elements.loadingOverlay.setAttribute('aria-hidden', 'true');
        document.body.classList.remove('blocking-overlay-active');
        if (!state.modal) {
          document.body.classList.remove('modal-open');
        }
        if (elements.appShell instanceof HTMLElement) {
          elements.appShell.removeAttribute('inert');
          elements.appShell.removeAttribute('aria-hidden');
        }
        if (overlayReturnFocus && document.contains(overlayReturnFocus)) {
          try {
            overlayReturnFocus.focus();
          } catch (error) {
            // ignore
          }
        }
        overlayReturnFocus = null;
      }

      function getCurrentNotebook() {
        if (!state.currentNotebook) return null;
        return state.notebooks.find((notebook) => notebook.slug === state.currentNotebook) || null;
      }

      function showStatus(message, type = '') {
        if (!elements.statusLine) return;
        if (statusTimeout) {
          window.clearTimeout(statusTimeout);
          statusTimeout = null;
        }

        if (!message) {
          elements.statusLine.textContent = '';
          elements.statusLine.className = 'status-line';
          return;
        }

        elements.statusLine.textContent = message;
        elements.statusLine.className = `status-line ${type}`;
        if (type !== 'loading') {
          statusTimeout = window.setTimeout(() => {
            elements.statusLine.textContent = '';
            elements.statusLine.className = 'status-line';
          }, 4000);
        }
      }

      function storeNotebook(slug) {
        if (!slug) {
          clearStoredNotebook();
          return;
        }
        window.localStorage.setItem(NOTEBOOK_STORAGE_KEY, slug);
      }

      function clearStoredNotebook() {
        window.localStorage.removeItem(NOTEBOOK_STORAGE_KEY);
      }

      function truncate(text, length) {
        if (text.length <= length) return text;
        return text.slice(0, length - 1) + '…';
      }

      function getLogTitle(log) {
        if (!log) {
          return 'Untitled entry';
        }

        const text = typeof log.text === 'string' ? log.text.trim() : '';
        if (text) {
          const firstLine = text.split(/\r?\n/).find((line) => line.trim().length > 0) || text;
          return truncate(firstLine.trim(), 64);
        }

        if (typeof log.date === 'string' && log.date.trim().length > 0) {
          return `Captured ${log.date}`;
        }

        return 'Untitled entry';
      }

      function getLogSummary(log) {
        if (!log || typeof log.text !== 'string') {
          return '';
        }

        const text = log.text.replace(/\s+/g, ' ').trim();
        if (!text) {
          return '';
        }

        return truncate(text, 72);
      }

      async function addAttachmentFromFile(file, fallbackName) {
        try {
          const dataUrl = await readFileAsDataUrl(file);
          pushAttachment({
            dataUrl,
            mimeType: file.type,
            name: file.name || fallbackName || undefined
          });
          return true;
        } catch (error) {
          console.error('Failed to attach image file', error);
          showStatus(`Unable to attach ${file.name || fallbackName || 'image'}.`, 'error');
          return false;
        }
      }

      async function extractClipboardImages(clipboardData) {
        const files = [];

        if (clipboardData.items && clipboardData.items.length > 0) {
          for (const item of clipboardData.items) {
            if (
              (item.kind === 'file' || typeof item.kind === 'undefined') &&
              item.type &&
              item.type.startsWith('image/')
            ) {
              const file = item.getAsFile();
              if (file) {
                files.push(file);
              }
            }
          }
        }

        if (files.length === 0 && clipboardData.files && clipboardData.files.length > 0) {
          for (const file of Array.from(clipboardData.files)) {
            if (file.type && file.type.startsWith('image/')) {
              files.push(file);
            }
          }
        }

        return files;
      }

      async function readJson(response) {
        try {
          return await response.json();
        } catch (error) {
          return null;
        }
      }

      function escapeHtml(value) {
        const div = document.createElement('div');
        div.textContent = value;
        return div.innerHTML;
      }

      function escapeAttribute(value) {
        return String(value)
          .replace(/&/g, '&amp;')
          .replace(/"/g, '&quot;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/'/g, '&#39;');
      }

      function readFileAsDataUrl(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => {
            if (typeof reader.result === 'string') {
              resolve(reader.result);
            } else {
              reject(new Error('Failed to read file'));
            }
          };
          reader.onerror = () => {
            reject(reader.error || new Error('Failed to read file'));
          };
          reader.readAsDataURL(file);
        });
      }
    })();
  </script>
</body>
</html>
